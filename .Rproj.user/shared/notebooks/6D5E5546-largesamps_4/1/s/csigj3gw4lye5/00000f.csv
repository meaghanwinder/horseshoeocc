"0","rm(list = ls())"
"0","library(R2jags);library(tidyverse);library(rstan);library(coda);library(HDInterval);library(truncnorm);library(latex2exp)"
"0","jags_summary <- function(fit, warmup = nrow(fit[[1]])/2, thin = 1){"
"0","  # convert to coda for normal summary"
"0","  fit_warmup <- lapply(fit, function(x) x[(warmup+1):nrow(x),])"
"0","  coda_samples <- as.mcmc.list(lapply(fit_warmup, function(x) as.mcmc("
"0","    x, start = warmup+1, end = nrow(fit), thin = thin"
"0","  )))"
"0","  "
"0","  sum <- summary(coda_samples)"
"0","  params <- dimnames(sum$statistics)[[1]]"
"0","  tmp_sum <- cbind(sum$statistics, sum$quantiles)"
"0","  "
"0","  # get r hat / n_eff"
"0","  mat <- matrix(NA, nrow = nrow(tmp_sum), ncol = 3)"
"0","  colnames(mat) <- c(""Rhat"", ""ess_bulk"", ""ess_tail"")"
"0","  for(i in 1:nrow(tmp_sum)){"
"0","    tmp <- sapply(fit, function(x) x[,i])"
"0","    mat[i,] <- c(Rhat(tmp), ess_bulk(tmp), ess_tail(tmp))"
"0","  }"
"0","  "
"0","  # get hdi interval"
"0","  all_samps <- do.call(""rbind"", coda_samples)"
"0","  hdi_lower <- apply(all_samps, 2, hdi)[1, ]"
"0","  hdi_upper <- apply(all_samps, 2, hdi)[2, ]"
"0","  "
"0","  # get median"
"0","  median <- apply(all_samps, 2, median)"
"0","  "
"0","  # # get mode"
"0","  # all_samps <- do.call(""rbind"", coda_samples)"
"0","  # mod <- apply(all_samps, 2, getmode)"
"0","  # prob <- apply(all_samps, 2, mean)"
"0","  "
"0","  # contains 0 "
"0","  contain0 <- tmp_sum[,5]<0 & tmp_sum[,9]>0"
"0","  "
"0","  contain0_hdi <- hdi_lower<0 & hdi_upper>0"
"0","  "
"0","  # out"
"0","  out <- cbind(tmp_sum, "
"0","               contain0 = contain0, "
"0","               # mode = mod, prob = prob, "
"0","               Median = median, "
"0","               hdi_lower, "
"0","               hdi_upper,"
"0","               mat)"
"0","  return(out)"
"0","}"
"0","trace_plot <- function(samples, which = c(""sigma"")){"
"0","  niter <- dim(samples[[1]])[1]"
"0","  nchains <- length(samples)"
"0","  params <- colnames(samples[[1]])"
"0","  "
"0","  combined_samples <- do.call(""rbind"", samples)"
"0","  combined_samples <- combined_samples %>%"
"0","    as_tibble %>%"
"0","    mutate(iter = rep(1:niter, nchains), chain = factor(rep(1:nchains, each = niter))) %>%"
"0","    dplyr::select(chain, iter, everything()) %>%"
"0","    pivot_longer(cols = -c(1:2), names_to = ""param"", values_to = ""trace"")"
"0","  "
"0","  if(all(is.numeric(which))) which <- unique(combined_samples$param)[which]"
"0","  "
"0","  p <- combined_samples %>%"
"0","    filter(param %in% which) %>%"
"0","    ggplot() + "
"0","    geom_line(aes(x = iter, y = trace, col = chain, group = chain)) +"
"0","    theme_bw() +"
"0","    facet_wrap(~ param, scales = ""free_y"")"
"0","  "
"0","  return(p)"
"0","  "
"0","}"
"0","convert_to_list <- function(fit){"
"0","  nchains <- fit$BUGSoutput$n.chains"
"0","  nkeep <- fit$BUGSoutput$n.keep"
"0","  array <- fit$BUGSoutput$sims.array"
"0","  "
"0","  out <- list()"
"0","  for(i in 1:(dim(array)[2])) out[[i]] <- array[,i,]"
"0","  return(out)"
"0","}"
"0",""
"0","cred_plot <- function(summary, which = c(""beta""), ylim = c(-4, 4)){"
"0","  plot_df <- summary %>%"
"0","    data.frame() %>% "
"0","    filter(str_detect(rownames(.), ""beta"")) %>% "
"0","    filter(rownames(.) != ""beta0"") %>% "
"0","    mutate(param = str_extract(rownames(.), ""(?<=\\[)[:digit:]+"")) %>% "
"0","    filter(rownames(.) != ""beta[1]"" & rownames(.) != ""beta[2]"") %>% "
"0","    select(param, Median, hdi_lower, hdi_upper)"
"0","  "
"0","  p <- plot_df %>% "
"0","    ggplot(aes(x = as.numeric(param))) + "
"0","    # geom_hline(yintercept = 0) + "
"0","    ylim(ylim[1], ylim[2]) + "
"0","    geom_linerange(aes(ymin = hdi_lower, ymax = hdi_upper), "
"0","                   color = ""grey"", "
"0","                   linewidth = 1) + "
"0","    labs(x = ""Variable"", "
"0","         y = """") + "
"0","    geom_point(aes(y = Median)) + "
"0","    theme_bw()"
"0","  "
"0","  return(p)"
"0","}"
"0",""
"0","meff_plot <- function(samples, title = NULL, x = TeX(""$m_{eff}$""), y = NULL, prior = NULL){"
"0","  # posterior info"
"0","  all_samps <- do.call(""rbind"", samples)"
"0","  samps <- all_samps %>% "
"0","    data.frame %>% "
"0","    select(mefft)"
"0","  "
"0","   p <- samps %>% "
"0","    ggplot(aes(x = mefft)) +"
"0","    geom_histogram(bins = 20) +"
"0","    labs(title = title, "
"0","         x = x, "
"0","         y = y) + "
"0","     theme_bw() + "
"0","     theme(axis.text.y = element_blank(), "
"0","           axis.ticks.y = element_blank(), "
"0","           text = element_text(size = 8, hjust = 0.1)"
"0","     ) "
"0","  "
"0","   return(p)"
"0","}"
